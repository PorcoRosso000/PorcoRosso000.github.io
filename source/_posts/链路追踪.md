---
title: 链路追踪
typora-root-url: 链路追踪
abbrlink: a86bf330
date: 2022-11-26 16:56:25
keywords: '链路追踪'
tags: 链路追踪
categories: 链路追踪
photos:
description: 链路追踪
---

链路追踪

<!--more-->

------



## 链路追踪

链路追踪解决的问题：

​	整个请求调用了哪些应用？哪些模块？哪些节点？以及它们的先后顺序和各部分的性能如何呢？  

链路追踪的作用:

​	将一次分布式请求还原成调用链路，并且将请求的调用情况集中展示，比如，各个服务节点上的耗时、请求具体到达哪台机器上、每个服务节点的请求状态等。

 衡量一个接口，我们一般会看三个指标：

 	1、接口的 RT（Route-Target 路由目标）你怎么知道?
 	2、接口是否有异常响应?
 	3、接口请求慢在哪里?

 微服务这种架构下的几个痛点：

 	1、排查问题难度大，周期长
 	2、特定场景难复现
 	3、系统性能瓶颈分析较难

 它主要的作用如下：

 	1、自动采取数据
 	2、分析数据，产生完整调用链：有了请求的完整调用链，问题有很大概率可复现
 	3、数据可视化：每个组件的性能可视化，能帮助我们很好地定位系统的瓶颈，及时找出问题所在

 	通过分布式追踪系统，我们能很好地定位请求的每条具体请求链路，从而轻易地实现请求链路追踪，进而定位和分析每个模块的性能瓶颈。

我上次使用链路追踪是使用sleuth+zipkin实现的 首先添加sleuth和zipkin的相关依赖还有配置，启动下载好的zipkin的jar包 调用我们的接口，就可以在zipkin客户端中看到接口的请求状态 请求时间 还有服务的依赖关系使用mysql实现数据的持久话将链路追踪的数据持久化到数据库中，链路信息将不会消失。  

zipkin的四大核心组件：

Collector：收集器组件，它主要用于处理从外部系统发送过来的跟踪信息，将这些信息转换为Zipkin 内部处理的 Span 格式，以支持后续的存储、分析、展示等功能。

Storage：存储组件，它主要对处理收集器接收到的跟踪信息，默认会将这些信息存储在内存中，我们也可以修改此存储策略，通过使用其他存储组件将跟踪信息存储到数据库中。

RESTful API：API 组件，它主要用来提供外部访问接口。比如给客户端展示跟踪信息，或是外接系统访问以实现监控等。

Web UI：UI 组件，基于 API 组件实现的上层应用。通过 UI 组件用户可以方便而有直观地查询和分析跟踪信息。

链路追踪:

排查方法:

可视化工具sleuth+可视化zipkin

链路追踪功能更全面

重点原理：

traceId — 为一个请求分配的ID号，用来标识一条请求链路。
 spanId — 表示一个基本的工作单元，一个请求可以包含多个步骤，每个步骤都拥有自己的spanId。一个请求包含一个TraceId，多个SpanId
 export — 布尔类型。表示是否要将该信息输出到类似Zipkin这样的聚合器进行收集和展示。

Collector：收集器组件，它主要用于处理从外部系统发送过来的跟踪信息，将这些信息转换为Zipkin 内部处理的 Span 格式，以支持后续的存储、分析、展示等功能。

Storage：存储组件，它主要对处理收集器接收到的跟踪信息，默认会将这些信息存储在内存中，我们也可以修改此存储策略，通过使用其他存储组件将跟踪信息存储到数据库中。

通过识别traceId和spanId来确定每一个操作和操作中的每一步  

一般是在请求到达网关的开始，生成本次请求的traceid 和 在网关服务内的spanid ，将他们放在HTTP 请求头或者RPC调用的元数据里，在调用下游服务时继续向下传递。下游的RESTful API服务的全局路由中间件和RPC服务的拦截器里会接收请求携带的traceid 和生成当次请求在服务内部的spanid，从上游接收到的 spanid 在这里会被转换成 pspanid。除此之外我们甚至可以把 traceid 和 spanid 注入到一些数据库连接池应用里，让记录的慢SQL日志里同样能打上 traceid 和 spanid 信息，为请求的响应过慢提供有效的分析数据。  

 skywalking

## 什么是 Sleuth

Spring Cloud Sleuth 为 Spring Cloud 实现了分布式跟踪解决方案。兼容 Zipkin，HTrace 和其他基于日志的追踪系统，例如 ELK（Elasticsearch 、Logstash、 Kibana）。

Spring Cloud Sleuth 提供了以下功能：

- 链路追踪：通过 	Sleuth 	可以很清楚的看出一个请求都经过了那些服务，可以很方便的理清服务间的调用关系等。
- 性能分析：通过 	Sleuth 	可以很方便的看出每个采样请求的耗时，分析哪些服务调用比较耗时，当服务调用的耗时随着请求量的增大而增大时， 	可以对服务的扩容提供一定的提醒。
- 数据分析，优化链路：对于频繁调用一个服务，或并行调用等，可以针对业务做一些优化措施。
- 可视化错误：对于程序未捕获的异常，可以配合 	Zipkin 	查看。